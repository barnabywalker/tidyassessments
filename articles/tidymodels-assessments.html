<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using tidymodels to make automated assessments • tidyassessments</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using tidymodels to make automated assessments">
<meta property="og:description" content="tidyassessments">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidyassessments</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tidymodels-assessments.html">Using tidymodels to make automated assessments</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tidymodels-assessments_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using tidymodels to make automated assessments</h1>
            
      
      
      <div class="hidden name"><code>tidymodels-assessments.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue" class="external-link">glue</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://barnabywalker.github.io/tidyassessments/" class="external-link">tidyassessments</a></span><span class="op">)</span></code></pre></div>
<p>Automated assessment methods use parameters or predictors to predict or assign preliminary IUCN Red List categories to species. <a href="https://www.tidymodels.org/" class="external-link">tidymodels</a> can help to provide a consistent interface to a range of statistical and machine learning models.</p>
<p>Here, I’ll go through the general flow of setting up and running a model using tidymodels.</p>
<div class="section level2">
<h2 id="input-data">Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h2>
<p>Before getting to tidymodels, the first thing we need is some data to train our model with.</p>
<p>We usually need a set of parameters or predictors calculated at the species level to run an automated conservation assessment. So we can focus on the tidymodels approach, we’ll just use something pre-prepared.</p>
<p>I’ve included an example dataset in this package called <code>myrcia_predictors</code>. This is a set of 13 continuous numeric quantities calculated from GBIF occurrence records for all accepted species in the genus <em>Myrcia</em>. We calculated these as part of our paper <a href="https://doi.org/10.32942/osf.io/zxq6s" class="external-link">“Evidence-based guidelines for automated conservation assessments of plant species”</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">myrcia_predictors</span><span class="op">)</span>
<span class="co">#&gt; Rows: 666</span>
<span class="co">#&gt; Columns: 18</span>
<span class="co">#&gt; $ wcvp_id              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "1005985-2", "165955-2", "165982-2", "166012-2", …</span>
<span class="co">#&gt; $ eoo                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 5.852548e+06, 2.189483e+05, 5.216963e+06, 7.21987…</span>
<span class="co">#&gt; $ human_footprint      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1.40550539, 0.79760157, 6.43746221, 3.37791242, 1…</span>
<span class="co">#&gt; $ human_population     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.046968e-02, 3.165635e-04, 1.983079e-02, 2.38729…</span>
<span class="co">#&gt; $ forest_loss          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.0229078334, 0.0058167546, 0.0870502486, 0.01589…</span>
<span class="co">#&gt; $ annual_temperature   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 256.0336, 227.5473, 256.3566, 264.0668, 235.7427,…</span>
<span class="co">#&gt; $ precipitation_driest <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 323.52557, 223.27577, 234.64264, 238.36092, 163.9…</span>
<span class="co">#&gt; $ elevation            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1523.86560, 1507.69812, 1911.90186, 2229.42627, 7…</span>
<span class="co">#&gt; $ conr_eoo             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 6048292, 218811, 5277809, 726755, 10752, NA, 4007…</span>
<span class="co">#&gt; $ conr_aoo             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 328, 76, 132, 212, 28, 4, 176, 1004, 132, 308, 32…</span>
<span class="co">#&gt; $ conr_locs            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 59, 16, 33, 38, 7, 1, 34, 222, 27, 71, 4, 172, 8,…</span>
<span class="co">#&gt; $ conr_obs             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 102, 22, 41, 68, 7, 1, 58, 301, 45, 93, 14, 264, …</span>
<span class="co">#&gt; $ n_specimens          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 181, 27, 61, 107, 9, 2, 89, 470, 102, 127, 15, 59…</span>
<span class="co">#&gt; $ centroid_latitude    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.05035375, 5.47690836, -1.49773510, 4.25111231, …</span>
<span class="co">#&gt; $ name                 <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Myrcia clusiifolia", "Myrcia rotundata", "Myrcia…</span>
<span class="co">#&gt; $ category             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "LC", "LC", "LC", "LC", "EN", "DD", "LC", "LC", "…</span>
<span class="co">#&gt; $ genus                <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Myrcia", "Myrcia", "Myrcia", "Myrcia", "Myrcia",…</span>
<span class="co">#&gt; $ section              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Myrcia", "Aulomyrcia", "Myrcia", "Aulomyrcia", "…</span></code></pre></div>
<p>As you can see, there are a variety of numeric predictors alongside the species name and identifier (“wcvp_id”). There is also some taxonomic info (“genus”, “section”) and the IUCN Red List category (“category”).</p>
<p>First we’ll split the species into ones that have been assessed (<code>labelled</code>) and those that haven’t (<code>unlabelled</code>). We’ll include Data Deficient species in <code>unlabelled</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">labelled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">myrcia_predictors</span>, <span class="va">category</span> <span class="op">!=</span> <span class="st">"DD"</span>, <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">category</span><span class="op">)</span><span class="op">)</span>
<span class="va">unlabelled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">myrcia_predictors</span>, <span class="va">category</span> <span class="op">==</span> <span class="st">"DD"</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">category</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{nrow(labelled)} labelled examples for training and evaluation"</span>, 
     <span class="st">"{nrow(unlabelled)} unlabelled examples for prediction"</span>, .sep<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; 346 labelled examples for training and evaluation</span>
<span class="co">#&gt; 320 unlabelled examples for prediction</span></code></pre></div>
<p>Next, we’ll make our prediction target the binarised categories “threatened” (VU, EN, CR) and “not threatened” (LC and NT), to simplify things.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">labelled</span><span class="op">$</span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">labelled</span><span class="op">$</span><span class="va">category</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LC"</span>, <span class="st">"NT"</span><span class="op">)</span>, <span class="st">"not threatened"</span>, <span class="st">"threatened"</span><span class="op">)</span>
<span class="va">labelled</span><span class="op">$</span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">labelled</span><span class="op">$</span><span class="va">obs</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"threatened"</span>, <span class="st">"not threatened"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{percent_format(accuracy=0.1)(mean(labelled$obs == 'threatened'))}"</span>,
     <span class="st">"of training/evaluation species are threatened"</span>, .sep<span class="op">=</span><span class="st">" "</span><span class="op">)</span>
<span class="co">#&gt; 44.8% of training/evaluation species are threatened</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-budget">Data budget<a class="anchor" aria-label="anchor" href="#data-budget"></a>
</h2>
<p>Before training any model, we need to determine our data budget - how we’ll split our data for the different steps of our process. How we split the data will depend on what exactly we need to do. <a href="https://arxiv.org/abs/1811.12808" class="external-link">This paper from Sebastian Raschka</a> gives a really detailed overview of different approaches to splitting data, and when you might want to use what approach.</p>
<p>In our case, we just want to estimate how our model will perform on unseen data. We have a relatively small dataset, so a single training/test split might give us a biased performance estimate. Instead, we’ll use 5-fold cross-validation. Alternatively, we could use bootstrap resampling, which would also give us confidence intervals on the performance.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span>v<span class="op">=</span><span class="fl">5</span>, data<span class="op">=</span><span class="va">labelled</span><span class="op">)</span>
<span class="va">folds</span>
<span class="co">#&gt; #  5-fold cross-validation </span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span>
<span class="co">#&gt;   splits           id   </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">&lt;split [276/70]&gt;</span> Fold1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="color: #949494;">&lt;split [277/69]&gt;</span> Fold2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="color: #949494;">&lt;split [277/69]&gt;</span> Fold3</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> <span style="color: #949494;">&lt;split [277/69]&gt;</span> Fold4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> <span style="color: #949494;">&lt;split [277/69]&gt;</span> Fold5</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="evaluation-metrics">Evaluation metrics<a class="anchor" aria-label="anchor" href="#evaluation-metrics"></a>
</h2>
<p>Another thing to set up before we actually get to training a model is what metric we want to use to evaluate it.</p>
<p>For our purposes we care about a few things:</p>
<ul>
<li>the proportion of species our model correctly classifies, measured by <strong>accuracy</strong>
</li>
<li>the proportion of threatened species our model correctly identifies, measured by <strong>sensitivity</strong>
</li>
<li>the proportion of not threatened species our model correctly identifies, measured by <strong>specificity</strong>
</li>
</ul>
<p>The picture of model performance given by these three measures can be contradictory sometimes (e.g. a high accuracy with high specificity, but a low sensitivity) and it can be hard to weigh up how good a model is without a single measure of performance. Associating different costs with wrongly classifying a threatened species and wrongly classifying a not threatened species (in terms of money, time, or some other quantity) would be ideal. But when we’re not clear on the costs, and we can use a single measure that balances the different types of misclassification.</p>
<p>In this case, we’ll use the true skill statistic (also called Youden’s J-index), which is defined as <code>sensitivity + specificity - 1</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">accuracy</span>, <span class="va">sensitivity</span>, <span class="va">specificity</span>, <span class="va">j_index</span><span class="op">)</span>
<span class="va">metrics</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span>
<span class="co">#&gt;   metric      class        direction</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy    class_metric maximize </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> sensitivity class_metric maximize </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> specificity class_metric maximize </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> j_index     class_metric maximize</span></code></pre></div>
<p>We’ll calculate all four of these metrics so we get a full picture of how our model is performing.</p>
</div>
<div class="section level2">
<h2 id="pre-processing">Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing"></a>
</h2>
<p>The next step in our process is to define which predictors our model will use and any pre-processing steps we need to do to them.</p>
<p>To define our predictors, we use the R formula specification. For many machine learning models, we just need to add each predictor as a term in the formula. For some other models, like a GLM, you might need to specify interactions between terms as well.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span>
  <span class="va">obs</span> <span class="op">~</span> <span class="va">eoo</span> <span class="op">+</span> <span class="va">centroid_latitude</span> <span class="op">+</span> <span class="va">human_population</span> <span class="op">+</span> <span class="va">precipitation_driest</span> <span class="op">+</span> <span class="va">forest_loss</span>
<span class="op">)</span></code></pre></div>
<p>Once we have our formula, we set up a recipe that details each of our pre-processing steps. The ones we’ll use here:</p>
<ul>
<li>impute missing predictor values using K-nearest neighbours (<code>step_impute_knn</code>)</li>
<li>remove any predictors with correlation above 0.9 to another predictor (<code>step_corr</code>)</li>
<li>remove any predictors with zero-variance (<code>step_zv</code>)</li>
<li>mean center and scale each predictor by it’s standard deviation (<code>step_normalize</code>)</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rec</span> <span class="op">&lt;-</span> 
    <span class="fu">recipe</span><span class="op">(</span><span class="va">form</span>, data<span class="op">=</span><span class="va">labelled</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">step_impute_knn</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">step_corr</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span>, threshold<span class="op">=</span><span class="fl">0.9</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">step_zv</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu">step_normalize</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">rec</span>
<span class="co">#&gt; Recipe</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Inputs:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;       role #variables</span>
<span class="co">#&gt;    outcome          1</span>
<span class="co">#&gt;  predictor          5</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Operations:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; K-nearest neighbor imputation for all_predictors()</span>
<span class="co">#&gt; Correlation filter on all_predictors()</span>
<span class="co">#&gt; Zero variance filter on all_predictors()</span>
<span class="co">#&gt; Centering and scaling for all_predictors()</span></code></pre></div>
<p>The important thing here is that we haven’t applied any of these steps to our data yet, this is just the specification.</p>
<p>One advantage of this is it prevents any data leakage between our training and test sets, because all calculations (like the mean and standard deviation for normalisation) will only be performed on the training data sets. It also lets us reuse the same recipe for different models and different datasets.</p>
</div>
<div class="section level2">
<h2 id="model-specification">Model specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h2>
<p>Now we get to specifying the model we want to use.</p>
<p>The thinking behind these specifications is to separate the type of model from the package that implements it.</p>
<p>So below, we’ve said that we want a random forest model with 1000 trees.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spec</span> <span class="op">&lt;-</span>
  <span class="fu">rand_forest</span><span class="op">(</span>trees<span class="op">=</span><span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"randomForest"</span>, importance<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span>

<span class="va">spec</span>
<span class="co">#&gt; Random Forest Model Specification (classification)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   trees = 1000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Engine-Specific Arguments:</span>
<span class="co">#&gt;   importance = TRUE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: randomForest</span></code></pre></div>
<p>After that, we say that we want to use the implementation from the “randomForest” package. We can also specify which engine-specific arguments we want at this point - for instance that we want to calculate feature importance.</p>
<p>The final part of the specification is the mode we want to use. This is determined by the problem we’re trying to solve. In the case of automated assessments, we’re usually trying to predict which IUCN category a species belongs to, so we chose “classification”.</p>
</div>
<div class="section level2">
<h2 id="creating-a-workflow">Creating a workflow<a class="anchor" aria-label="anchor" href="#creating-a-workflow"></a>
</h2>
<p>The final part of setting everything up is to link the pre-processing recipe to the model specification in a workflow.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wf</span> <span class="op">&lt;-</span> 
  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">rec</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu">add_model</span><span class="op">(</span><span class="va">spec</span><span class="op">)</span>

<span class="va">wf</span>
<span class="co">#&gt; ══ Workflow ════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span>
<span class="co">#&gt; <span style="font-style: italic;">Model:</span> rand_forest()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Preprocessor ────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt; 4 Recipe Steps</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; • step_impute_knn()</span>
<span class="co">#&gt; • step_corr()</span>
<span class="co">#&gt; • step_zv()</span>
<span class="co">#&gt; • step_normalize()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Model ───────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt; Random Forest Model Specification (classification)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   trees = 1000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Engine-Specific Arguments:</span>
<span class="co">#&gt;   importance = TRUE</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: randomForest</span></code></pre></div>
<p>As we mentioned before, this helps to prevent data leakage when training and evaluating our model. It also has the benefit of allowing us to set up multiple workflows, using the same pre-processing recipe with a range of different model specifications, or multiple pre-processing recipes with the same model.</p>
<p>The possibilities are endless!</p>
</div>
<div class="section level2">
<h2 id="evaluating-our-model">Evaluating our model<a class="anchor" aria-label="anchor" href="#evaluating-our-model"></a>
</h2>
<p>We can now evaluate the performance of our whole workflow using the data budget we set up before.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">fit_resamples</span><span class="op">(</span>
  <span class="va">wf</span>, 
  <span class="va">folds</span>, 
  metrics<span class="op">=</span><span class="va">metrics</span>,
  control<span class="op">=</span><span class="fu">control_resamples</span><span class="op">(</span>save_pred<span class="op">=</span><span class="cn">TRUE</span>, save_workflow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu">collect_metrics</span><span class="op">(</span><span class="va">results</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span>
<span class="co">#&gt;   .metric     .estimator  mean     n std_err .config             </span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> accuracy    binary     0.795     5  0.012<span style="text-decoration: underline;">5</span> Preprocessor1_Model1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> j_index     binary     0.587     5  0.030<span style="text-decoration: underline;">9</span> Preprocessor1_Model1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> sensitivity binary     0.756     5  0.043<span style="text-decoration: underline;">6</span> Preprocessor1_Model1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> specificity binary     0.831     5  0.033<span style="text-decoration: underline;">8</span> Preprocessor1_Model1</span></code></pre></div>
<p>This gives us an estimate of how our model will perform on completely new data, that it hasn’t seen before.</p>
</div>
<div class="section level2">
<h2 id="predicting-threat">Predicting threat<a class="anchor" aria-label="anchor" href="#predicting-threat"></a>
</h2>
<p>The final step is to use our model to make predictions.</p>
<p>We want our model to learn from as much data as possible, so we fit the model for a final time on our whole labelled dataset. This is fine, because we don’t intend to evaluate the performance of our model on any part of it again.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">wf</span>, <span class="va">labelled</span><span class="op">)</span>
<span class="va">m</span>
<span class="co">#&gt; ══ Workflow [trained] ══════════════════════════════════════════════════════════</span>
<span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span>
<span class="co">#&gt; <span style="font-style: italic;">Model:</span> rand_forest()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Preprocessor ────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt; 4 Recipe Steps</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; • step_impute_knn()</span>
<span class="co">#&gt; • step_corr()</span>
<span class="co">#&gt; • step_zv()</span>
<span class="co">#&gt; • step_normalize()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ── Model ───────────────────────────────────────────────────────────────────────</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;  randomForest(x = maybe_data_frame(x), y = y, ntree = ~1000, importance = ~TRUE) </span>
<span class="co">#&gt;                Type of random forest: classification</span>
<span class="co">#&gt;                      Number of trees: 1000</span>
<span class="co">#&gt; No. of variables tried at each split: 2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;         OOB estimate of  error rate: 19.65%</span>
<span class="co">#&gt; Confusion matrix:</span>
<span class="co">#&gt;                threatened not threatened class.error</span>
<span class="co">#&gt; threatened            118             37   0.2387097</span>
<span class="co">#&gt; not threatened         31            160   0.1623037</span></code></pre></div>
<p>One thing that you might notice from the model summary above is that it has its own report of the model performance called the “OOB estimate of error rate”. This is the “out-of-bag” error - each tree of the random forest model is trained on a different subset of the training data, and the OOB error is evaluated for each tree on the data not included in that subset.</p>
<p>We could use that as our estimate of how well the model performs, but generally I prefer to use the cross-validation setup we used above. One reason is that it allows the same cross-validation splits to be used to compare the performance of multiple models. Another is that sometimes the OOB error might be a little bit more pessimistic that cross-validation, but generally they agree quite well.</p>
<p>Now we have our final model, we can at last estimate the total proportion of <em>Myrcia</em> species that are threatened (including those already assessed).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">myrcia_predictors</span><span class="op">)</span>
<span class="va">prop_threatened</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">.pred_class</span> <span class="op">==</span> <span class="st">"threatened"</span><span class="op">)</span>
<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{percent_format(accuracy=0.1)(prop_threatened)} of Myrcia species predicted threatened"</span><span class="op">)</span>
<span class="co">#&gt; 61.9% of Myrcia species predicted threatened</span></code></pre></div>
<p>Much higher than the proportion of assessed <em>Myrcia</em> species that are threatened!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Barnaby Walker.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
